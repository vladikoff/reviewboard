{% load i18n %}
{% if widget_data.change_descriptions %}
<div id="placeholder-stats" style="width: 450px; height: 250px;"></div>

 <script>
$(function () {

// Change Descriptions - chart data
  var d = [[]
     {% for description in  widget_data.change_descriptions %}
           ,[{{description.timestamp|date:"U"}}000, {{description.created_count}}]
     {% endfor %}
    ];

// Comments - chart data
  var d3 = [[]
     {% for comment in  widget_data.comments %}
           ,[{{comment.timestamp|date:"U"}}000, {{comment.created_count}}]
     {% endfor %}
    ];

// Reviews - chart data
 var d4 = [[]
    {% for review in  widget_data.reviews %}
          ,[{{review.timestamp|date:"U"}}000, {{review.created_count}}]
    {% endfor %}
   ];

// Reviews - chart data
 var d5 = [[]
    {% for review_req in  widget_data.review_requests %}
          ,[{{review_req.time_added|date:"U"}}000, {{review_req.created_count}}]
    {% endfor %}
   ];


 var datasets = {
  "set-descriptions": {
   label: "Change Descriptions",  data: d,  bars: { show: true }, lines: {show: false}
  },
  "set-comments": {
   label: "Comments",  data: d3 ,  bars: { show: true }, lines: {show: false}
  },
  "set-reviews": {
   label: "Reviews",  data: d4,  bars: { show: true }, lines: {show: false}
  },
  "set-requests": {
   label: "Review Requests",  data: d5,  bars: { show: true }, lines: {show: false}
  }
  }

   // hard-code color indices to prevent them from shifting as
   // datasets are turned on/off
   var i = 0;
   $.each(datasets, function(key, val) {
       val.color = i;
       ++i;
   });

    // first correct the timestamps - they are recorded as the daily
    // midnights in UTC+0100, but Flot always displays dates in UTC
    // so we have to add one hour to hit the midnights in the plot
    for (var i = 0; i < d.length; ++i)
      d[i][0] += 60 * 60 * 1000;

    // helper for returning the weekends in a period
    function weekendAreas(axes) {
        var markings = [];
        var d = new Date(axes.xaxis.min);
        // go to the first Saturday
        d.setUTCDate(d.getUTCDate() - ((d.getUTCDay() + 1) % 7))
        d.setUTCSeconds(0);
        d.setUTCMinutes(0);
        d.setUTCHours(0);
        var i = d.getTime();
        do {
            // when we don't set yaxis, the rectangle automatically
            // extends to infinity upwards and downwards
            markings.push({ xaxis: {from: i, to: i + 2 * 24 * 60 * 60 * 1000}});
            i += 7 * 24 * 60 * 60 * 1000;
        } while (i < axes.xaxis.max);

        return markings;
    }

    var options = {
        xaxis: { mode: "time", tickLength: 1},
        yaxis : { min: 0 , tickDecimals: 0},
        grid: { markings: weekendAreas, hoverable: true },
        series: { points: { show: true, radius: 3 },   lines: { show: true }},
        legend: { position: 'nw' }
    };

    var choiceContainer = $("#stats-large");
    choiceContainer.find(".btn-s").click(plotAccordingToChoices);

    function plotAccordingToChoices() {
        var data = [];
        if ($(this).hasClass('btn-s-checked')) {
         $(this).removeClass('btn-s-checked');
        } else {
         $(this).addClass('btn-s-checked');
        }
        choiceContainer.find(".btn-s-checked").each(function () {
              var key = $(this).attr("id");
              if (key && datasets[key])
                  data.push(datasets[key]);
        });
        if (data.length > 0)
            $.plot($("#placeholder-stats"), data, options);
      return false;
    }

     function showTooltip(x, y, contents) {
           $('<div id="tooltip">' + contents + '</div>').css( {
               position: 'absolute',
               display: 'none',
               top: y + 5,
               left: x + 5,
               border: '1px solid #fdd',
               padding: '2px',
               'background-color': '#fee',
               opacity: 0.80
           }).appendTo("body").fadeIn(200);
       }

    var previousPoint = null;
        $("#placeholder-stats").bind("plothover", function (event, pos, item) {
            $("#x").text(pos.x.toFixed(2));
            $("#y").text(pos.y);

            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;

                    $("#tooltip").remove();
                    var itemDate = new Date(item.datapoint[0])
                    var x = itemDate,
                        y = item.datapoint[1];

                    showTooltip(item.pageX, item.pageY,
                                item.series.label + " on " + x + ": " + y);
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;
            }

        });

    plotAccordingToChoices();

});
</script>
{% else %}
<p class="no-result"> {% trans "No Data available at this time..." %}</p>
{% endif %}